#!/usr/bin/env python3
"""
GHS 분류 및 독성 계산 유틸리티
- 혼합물 ATEmix 계산
- GHS 유해위험성 분류 기준
- H문구/P문구 매핑
"""

from typing import Dict, List, Optional, Tuple
import re

# ============================================
# GHS 분류 기준
# ============================================

# 급성독성 분류 기준 (mg/kg 또는 ppm)
ACUTE_TOXICITY_CRITERIA = {
    'oral': {  # 경구
        1: (0, 5),
        2: (5, 50),
        3: (50, 300),
        4: (300, 2000),
        5: (2000, 5000)
    },
    'dermal': {  # 경피
        1: (0, 50),
        2: (50, 200),
        3: (200, 1000),
        4: (1000, 2000),
        5: (2000, 5000)
    },
    'inhalation_gas': {  # 흡입-가스 (ppm)
        1: (0, 100),
        2: (100, 500),
        3: (500, 2500),
        4: (2500, 20000),
        5: (20000, 50000)
    },
    'inhalation_vapor': {  # 흡입-증기 (mg/L)
        1: (0, 0.5),
        2: (0.5, 2),
        3: (2, 10),
        4: (10, 20),
        5: (20, 50)
    },
    'inhalation_dust': {  # 흡입-분진/미스트 (mg/L)
        1: (0, 0.05),
        2: (0.05, 0.5),
        3: (0.5, 1),
        4: (1, 5),
        5: (5, 10)
    }
}

# 수생독성 분류 기준 (mg/L)
AQUATIC_TOXICITY_CRITERIA = {
    'acute': {
        1: (0, 1),
        2: (1, 10),
        3: (10, 100)
    },
    'chronic': {
        1: (0, 0.1),
        2: (0.1, 1),
        3: (1, 10),
        4: (10, 100)
    }
}

# H문구 데이터베이스
H_STATEMENTS = {
    # 급성독성
    'H300': '삼키면 치명적임',
    'H301': '삼키면 유독함',
    'H302': '삼키면 유해함',
    'H303': '삼키면 유해할 수 있음',
    'H310': '피부와 접촉하면 치명적임',
    'H311': '피부와 접촉하면 유독함',
    'H312': '피부와 접촉하면 유해함',
    'H313': '피부와 접촉하면 유해할 수 있음',
    'H330': '흡입하면 치명적임',
    'H331': '흡입하면 유독함',
    'H332': '흡입하면 유해함',
    'H333': '흡입하면 유해할 수 있음',
    
    # 피부부식성/자극성
    'H314': '피부에 심한 화상과 눈 손상을 일으킴',
    'H315': '피부에 자극을 일으킴',
    
    # 눈손상성/자극성
    'H318': '눈에 심한 손상을 일으킴',
    'H319': '눈에 심한 자극을 일으킴',
    'H320': '눈에 자극을 일으킴',
    
    # 과민성
    'H317': '알레르기성 피부 반응을 일으킬 수 있음',
    'H334': '흡입시 알레르기성 반응, 천식 또는 호흡 곤란 등을 일으킬 수 있음',
    
    # CMR
    'H340': '유전적인 결함을 일으킬 수 있음',
    'H341': '유전적인 결함을 일으킬 것으로 의심됨',
    'H350': '암을 일으킬 수 있음',
    'H350i': '흡입하면 암을 일으킬 수 있음',
    'H351': '암을 일으킬 것으로 의심됨',
    'H360': '생식능 또는 태아에 손상을 일으킬 수 있음',
    'H360F': '생식능에 손상을 일으킬 수 있음',
    'H360D': '태아에 손상을 일으킬 수 있음',
    'H360FD': '생식능 또는 태아에 손상을 일으킬 수 있음',
    'H360Fd': '생식능에 손상을 일으킬 수 있음. 태아에 손상을 일으킬 것으로 의심됨',
    'H360Df': '태아에 손상을 일으킬 수 있음. 생식능에 손상을 일으킬 것으로 의심됨',
    'H361': '생식능 또는 태아에 손상을 일으킬 것으로 의심됨',
    'H361f': '생식능에 손상을 일으킬 것으로 의심됨',
    'H361d': '태아에 손상을 일으킬 것으로 의심됨',
    'H361fd': '생식능 또는 태아에 손상을 일으킬 것으로 의심됨',
    'H362': '모유를 먹는 아이에게 해를 끼칠 수 있음',
    
    # 특정표적장기독성
    'H370': '장기에 손상을 일으킴',
    'H371': '장기에 손상을 일으킬 수 있음',
    'H372': '장기간 또는 반복노출되면 장기에 손상을 일으킴',
    'H373': '장기간 또는 반복노출되면 장기에 손상을 일으킬 수 있음',
    
    # 흡인유해성
    'H304': '삼켜서 기도로 유입되면 치명적일 수 있음',
    'H305': '삼켜서 기도로 유입되면 유해할 수 있음',
    
    # 물리적 위험성
    'H200': '불안정한 폭발성 물질',
    'H201': '폭발성 물질; 대폭발 위험성',
    'H202': '폭발성 물질; 심한 발사 위험성',
    'H203': '폭발성 물질; 화재, 폭풍 또는 발사 위험성',
    'H204': '화재 또는 발사 위험성',
    'H205': '화재시 대폭발 위험성',
    'H220': '극인화성 가스',
    'H221': '인화성 가스',
    'H222': '극인화성 에어로졸',
    'H223': '인화성 에어로졸',
    'H224': '극인화성 액체 및 증기',
    'H225': '고인화성 액체 및 증기',
    'H226': '인화성 액체 및 증기',
    'H227': '가연성 액체',
    'H228': '인화성 고체',
    'H229': '가압용기: 가열하면 터질 수 있음',
    'H230': '공기가 없어도 폭발적으로 반응할 수 있음',
    'H231': '높은 압력/온도에서 공기가 없어도 폭발적으로 반응할 수 있음',
    'H240': '가열하면 폭발할 수 있음',
    'H241': '가열하면 화재 또는 폭발할 수 있음',
    'H242': '가열하면 화재를 일으킬 수 있음',
    'H250': '공기에 노출되면 자연 발화함',
    'H251': '자기발열성; 화재를 일으킬 수 있음',
    'H252': '대량으로 존재시 자기발열성; 화재를 일으킬 수 있음',
    'H260': '물과 접촉시 자연발화하는 인화성 가스를 발생시킴',
    'H261': '물과 접촉시 인화성 가스를 발생시킴',
    'H270': '화재를 일으키거나 강렬하게 함; 산화제',
    'H271': '화재 또는 폭발을 일으킬 수 있음; 강산화제',
    'H272': '화재를 강렬하게 할 수 있음; 산화제',
    'H280': '고압가스 포함; 가열하면 폭발할 수 있음',
    'H281': '냉동 가스 포함; 극저온 화상 또는 손상을 일으킬 수 있음',
    'H290': '금속을 부식시킬 수 있음',
    
    # 환경유해성
    'H400': '수생생물에 매우 유독함',
    'H410': '장기적 영향에 의해 수생생물에 매우 유독함',
    'H411': '장기적 영향에 의해 수생생물에 유독함',
    'H412': '장기적 영향에 의해 수생생물에 유해함',
    'H413': '장기적 영향에 의해 수생생물에 유해의 원인이 될 수 있음',
    'H420': '오존층을 파괴하여 공중 보건 및 환경에 해를 끼침'
}

# P문구 데이터베이스 (주요 항목)
P_STATEMENTS = {
    # 예방
    'P201': '사용 전 취급 설명서를 확보하시오',
    'P202': '모든 안전 예방조치 문구를 읽고 이해하기 전에는 취급하지 마시오',
    'P210': '열·스파크·화염·고온의 표면으로부터 멀리하시오 - 금연',
    'P211': '개방된 화염 또는 다른 점화원에 분무하지 마시오',
    'P220': '의류 및 가연성 물질로부터 멀리하시오',
    'P221': '가연성 물질과 혼합을 피하시오',
    'P222': '공기에 접촉시키지 마시오',
    'P223': '물에 접촉시키지 마시오',
    'P230': '~으로 젖은 상태를 유지하시오',
    'P231': '불활성 기체 및 ~을 제외한 수분이 없는 환경에서 취급하시오',
    'P232': '습기를 방지하시오',
    'P233': '용기를 단단히 밀폐하시오',
    'P234': '원래의 용기에만 보관하시오',
    'P235': '저온을 유지하시오',
    'P240': '용기와 수용설비를 접지/접합하시오',
    'P241': '방폭형 전기/환기/조명/~장비를 사용하시오',
    'P242': '불꽃을 일으키지 않는 도구만 사용하시오',
    'P243': '정전기 방지 조치를 취하시오',
    'P244': '밸브와 피팅에 그리스와 오일이 묻지 않도록 하시오',
    'P250': '갈아/충격을 가하지/마찰시키지 마시오',
    'P251': '사용 후에도 구멍을 뚫거나 불에 넣지 마시오',
    'P260': '분진·흄·가스·미스트·증기·스프레이를 흡입하지 마시오',
    'P261': '분진·흄·가스·미스트·증기·스프레이의 흡입을 피하시오',
    'P262': '눈, 피부, 의복에 묻지 않도록 하시오',
    'P263': '임신·수유 기간에는 접촉을 피하시오',
    'P264': '취급 후 ~을 철저히 씻으시오',
    'P270': '이 제품을 사용할 때에는 먹거나, 마시거나 흡연하지 마시오',
    'P271': '옥외 또는 환기가 잘 되는 곳에서만 사용하시오',
    'P272': '작업장 밖으로 오염된 의복을 반출하지 마시오',
    'P273': '환경으로 배출하지 마시오',
    'P280': '보호장갑/보호의/보안경/안면보호구를 착용하시오',
    'P281': '개인 보호구를 착용하시오',
    'P282': '단열장갑/안면보호구/보안경을 착용하시오',
    'P283': '방화복/난연성 의류를 착용하시오',
    'P284': '호흡기 보호구를 착용하시오',
    'P285': '환기가 충분하지 않은 경우 호흡기 보호구를 착용하시오',
    
    # 대응
    'P301': '삼킨 경우:',
    'P302': '피부에 묻은 경우:',
    'P303': '피부(또는 머리카락)에 묻은 경우:',
    'P304': '흡입한 경우:',
    'P305': '눈에 묻은 경우:',
    'P306': '의류에 묻은 경우:',
    'P307': '노출된 경우:',
    'P308': '노출되었거나 노출이 우려되는 경우:',
    'P310': '즉시 의료기관/의사/~에 연락하시오',
    'P311': '의료기관/의사/~에 연락하시오',
    'P312': '불편함을 느끼면 의료기관/의사/~에 연락하시오',
    'P313': '의학적인 조치/조언을 받으시오',
    'P314': '불편함을 느끼면 의학적인 조치/조언을 받으시오',
    'P315': '즉시 의학적인 조치/조언을 받으시오',
    'P320': '긴급치료가 필요함',
    'P321': '특정 처리를 하시오',
    'P322': '특정 처리를 하시오',
    'P330': '입을 씻어내시오',
    'P331': '토하게 하지 마시오',
    'P332': '피부 자극이 생기면:',
    'P333': '피부 자극 또는 홍반이 생기면:',
    'P334': '찬물에 담그거나 젖은 붕대로 감싸시오',
    'P335': '피부에 묻은 입자를 털어내시오',
    'P336': '찬물로 녹이시오. 환부를 젖은 붕대로 감싸시오',
    'P337': '눈의 자극이 지속되면:',
    'P338': '가능하면 콘택트 렌즈를 제거하시오. 계속 씻으시오',
    'P340': '피해자를 신선한 공기가 있는 곳으로 옮기고 호흡하기 쉬운 자세로 안정을 취하게 하시오',
    'P341': '호흡이 어려우면 피해자를 신선한 공기가 있는 곳으로 옮기고 호흡하기 쉬운 자세로 안정을 취하게 하시오',
    'P342': '호흡기 증상이 나타나면:',
    'P350': '비눗물로 조심스럽게 씻으시오',
    'P351': '물로 수 분간 조심해서 씻으시오',
    'P352': '비눗물로 충분히 씻으시오',
    'P353': '피부를 물로 씻으시오/샤워하시오',
    'P360': '소화하기 전에 누출된 화학물질을 물로 적시시오',
    'P361': '오염된 의복은 모두 즉시 벗으시오',
    'P362': '오염된 의복을 벗으시오',
    'P363': '다시 사용하기 전에 오염된 의류는 세척하시오',
    'P364': '재사용 전에 세척하시오',
    'P370': '화재시:',
    'P371': '대형 화재시:',
    'P372': '폭발 위험성',
    'P373': '화재가 폭발성 물질에 도달하면 소화하지 마시오',
    'P374': '적절한 거리를 유지하면서 화재를 진화하시오',
    'P375': '폭발 위험성이 있으므로 먼 거리에서 화재를 진화하시오',
    'P376': '안전하게 처리할 수 있으면 누출을 막으시오',
    'P377': '누출로 인한 가스 화재시: 누출이 안전하게 막혀지지 않으면 진화하지 마시오',
    'P378': '소화를 위해 ~을 사용하시오',
    'P380': '주위를 대피시키시오',
    'P381': '모든 점화원을 제거하시오',
    'P390': '물질 손상을 방지하기 위해 유출물을 흡수하시오',
    'P391': '유출물을 모으시오',
    
    # 저장
    'P401': '~에 저장하시오',
    'P402': '건조한 장소에 저장하시오',
    'P403': '환기가 잘 되는 곳에 저장하시오',
    'P404': '밀폐된 용기에 저장하시오',
    'P405': '잠금 장치가 있는 저장장소에 저장하시오',
    'P406': '부식방지 내장재 및 /.../ 내장재가 있는 용기에 저장하시오',
    'P407': '팔레트 사이에 공간을 두시오',
    'P410': '직사광선으로부터 보호하시오',
    'P411': '~℃/~℉ 이하의 온도에서 저장하시오',
    'P412': '50℃/122℉를 초과하는 온도에 노출시키지 마시오',
    'P413': '~kg/~lbs 이상의 덩어리 제품은 ~℃/~℉ 이하의 온도에서 저장하시오',
    'P420': '다른 물질과 함께 보관하지 마시오',
    
    # 폐기
    'P501': '내용물/용기를 ~에 폐기하시오',
    'P502': '재생 또는 재활용에 관한 정보에 대해서는 제조자/공급자에게 문의하시오',
    'P503': '폐기/재활용/재생 정보에 대해서는 제조자/공급자/~에게 문의하시오'
}

# ============================================
# ATEmix 계산 함수
# ============================================

def calculate_ate_mix(components: List[Dict]) -> Dict:
    """
    혼합물의 ATEmix 계산
    
    Args:
        components: [{'name': '물질명', 'cas': 'CAS번호', 'content': 함유량(%), 'ate': ATE값(mg/kg)}]
    
    Returns:
        {'ate_mix': 계산값, 'category': 구분, 'route': 노출경로}
    """
    results = {
        'oral': {'ate_mix': None, 'category': None},
        'dermal': {'ate_mix': None, 'category': None},
        'inhalation': {'ate_mix': None, 'category': None}
    }
    
    for route in ['oral', 'dermal', 'inhalation']:
        # 100/ATEmix = Σ(Ci/ATEi)
        sum_ci_atei = 0
        valid_components = 0
        
        for comp in components:
            ate_key = f'ate_{route}'
            if ate_key in comp and comp[ate_key] and comp['content']:
                ate_value = float(comp[ate_key])
                content = float(comp['content'])
                
                if ate_value > 0:
                    sum_ci_atei += content / ate_value
                    valid_components += 1
        
        if sum_ci_atei > 0 and valid_components > 0:
            ate_mix = 100 / sum_ci_atei
            results[route]['ate_mix'] = round(ate_mix, 2)
            
            # 분류 결정
            criteria = ACUTE_TOXICITY_CRITERIA.get(route, ACUTE_TOXICITY_CRITERIA['oral'])
            for cat, (low, high) in criteria.items():
                if low < ate_mix <= high:
                    results[route]['category'] = cat
                    break
            
            if results[route]['category'] is None and ate_mix > 5000:
                results[route]['category'] = '구분외'
    
    return results


def get_ghs_category(ate_value: float, route: str = 'oral') -> Optional[int]:
    """ATE 값으로 GHS 급성독성 구분 결정"""
    if ate_value is None or ate_value <= 0:
        return None
    
    criteria = ACUTE_TOXICITY_CRITERIA.get(route, ACUTE_TOXICITY_CRITERIA['oral'])
    
    for category, (low, high) in criteria.items():
        if low < ate_value <= high:
            return category
    
    return None  # 구분외


def get_h_statement(code: str) -> str:
    """H문구 코드로 문구 반환"""
    return H_STATEMENTS.get(code, '해당없음')


def get_p_statement(code: str) -> str:
    """P문구 코드로 문구 반환"""
    return P_STATEMENTS.get(code, '해당없음')


def parse_ate_from_text(text: str) -> Optional[float]:
    """텍스트에서 ATE/LD50/LC50 값 추출"""
    if not text:
        return None
    
    # LD50, LC50, ATE 패턴 매칭
    patterns = [
        r'LD50[:\s=]*(\d+(?:,\d+)?(?:\.\d+)?)\s*(?:mg/kg)?',
        r'LC50[:\s=]*(\d+(?:,\d+)?(?:\.\d+)?)\s*(?:mg/L|ppm)?',
        r'ATE[:\s=]*(\d+(?:,\d+)?(?:\.\d+)?)\s*(?:mg/kg)?',
        r'(\d+(?:,\d+)?(?:\.\d+)?)\s*mg/kg',
    ]
    
    for pattern in patterns:
        match = re.search(pattern, text, re.IGNORECASE)
        if match:
            value_str = match.group(1).replace(',', '')
            try:
                return float(value_str)
            except ValueError:
                continue
    
    return None


def generate_h_statements_from_classification(classifications: List[str]) -> List[str]:
    """GHS 분류에서 H문구 생성"""
    h_codes = []
    
    classification_to_h = {
        '급성 경구 독성 구분 1': 'H300',
        '급성 경구 독성 구분 2': 'H300',
        '급성 경구 독성 구분 3': 'H301',
        '급성 경구 독성 구분 4': 'H302',
        '급성 경구 독성 구분 5': 'H303',
        '급성 경피 독성 구분 1': 'H310',
        '급성 경피 독성 구분 2': 'H310',
        '급성 경피 독성 구분 3': 'H311',
        '급성 경피 독성 구분 4': 'H312',
        '급성 흡입 독성 구분 1': 'H330',
        '급성 흡입 독성 구분 2': 'H330',
        '급성 흡입 독성 구분 3': 'H331',
        '급성 흡입 독성 구분 4': 'H332',
        '피부 부식성 구분 1': 'H314',
        '피부 자극성 구분 2': 'H315',
        '심한 눈 손상성 구분 1': 'H318',
        '눈 자극성 구분 2': 'H319',
        '호흡기 과민성 구분 1': 'H334',
        '피부 과민성 구분 1': 'H317',
        '생식세포 변이원성 구분 1': 'H340',
        '생식세포 변이원성 구분 2': 'H341',
        '발암성 구분 1': 'H350',
        '발암성 구분 2': 'H351',
        '생식독성 구분 1': 'H360',
        '생식독성 구분 2': 'H361',
        '특정표적장기 독성(1회 노출) 구분 1': 'H370',
        '특정표적장기 독성(1회 노출) 구분 2': 'H371',
        '특정표적장기 독성(반복 노출) 구분 1': 'H372',
        '특정표적장기 독성(반복 노출) 구분 2': 'H373',
        '흡인 유해성 구분 1': 'H304',
        '인화성 액체 구분 1': 'H224',
        '인화성 액체 구분 2': 'H225',
        '인화성 액체 구분 3': 'H226',
        '인화성 가스 구분 1': 'H220',
        '인화성 가스 구분 2': 'H221',
        '수생환경 유해성 급성 구분 1': 'H400',
        '수생환경 유해성 만성 구분 1': 'H410',
        '수생환경 유해성 만성 구분 2': 'H411',
        '수생환경 유해성 만성 구분 3': 'H412',
        '수생환경 유해성 만성 구분 4': 'H413',
    }
    
    for classification in classifications:
        classification_clean = classification.strip()
        for key, h_code in classification_to_h.items():
            if key in classification_clean:
                if h_code not in h_codes:
                    h_codes.append(h_code)
    
    return h_codes


if __name__ == "__main__":
    # 테스트: ATEmix 계산
    components = [
        {'name': '아크릴산', 'content': 60, 'ate_oral': 300},
        {'name': '로릴 메타크릴산', 'content': 40, 'ate_oral': 87250}
    ]
    
    result = calculate_ate_mix(components)
    print(f"ATEmix (경구): {result['oral']['ate_mix']} mg/kg")
    print(f"분류: 구분{result['oral']['category']}")
